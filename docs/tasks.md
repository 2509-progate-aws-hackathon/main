# MapLibre マップ描画コンポーネント実装計画

## 計画目的
MapLibre GL JS を使用したマップ描画コンポーネントを実装し、WorstRouteアプリのルートページに配置する。

## 現在のコードベース分析

### プロジェクト構成
- **フレームワーク**: Next.js 15.5.3 (App Router)
- **React**: 19.1.0
- **TypeScript**: 使用済み
- **スタイル**: Tailwind CSS 4
- **フォルダ構造**: features ベースの構成を想定

### 必要な実装項目

## 実装タスク

### 1. 依存関係の追加
**ファイル**: `frontend/package.json`
- maplibre-gl
- @types/maplibre-gl
- AWS SDK関連パッケージ（将来の拡張用）

### 2. MapLibre コンポーネントの作成
**ファイル**: `frontend/app/components/MapLibre/MapComponent.tsx`
- 基本的な地図表示コンポーネント
- TypeScript型定義
- 初期設定（中心座標、ズームレベル）
- レスポンシブデザイン対応

### 3. カスタムフックの作成
**ファイル**: `frontend/app/hooks/useMapLibre.ts`
- MapLibre インスタンス管理
- 地図の初期化・破棄処理
- イベントハンドラー管理

### 4. ルートページの作成
**ファイル**: `frontend/app/route/page.tsx`
- MapComponent を配置
- ページレイアウトの構成
- 基本的なUI要素の配置

### 5. 型定義ファイルの作成
**ファイル**: `frontend/app/types/map.ts`
- MapLibre関連の型定義
- 座標、マーカー等の型定義

### 6. スタイル設定の追加
**ファイル**: `frontend/app/globals.css`
- MapLibre CSS の import
- カスタムマップスタイル

## 技術仕様

### MapLibre設定
- **マップスタイル**: OpenStreetMap ベース（デモ用）
- **初期表示**: 東京駅周辺 (35.6812, 139.7671)
- **初期ズームレベル**: 12
- **コントロール**: ズーム、回転、全画面表示

### レスポンシブ対応
- デスクトップ: フル画面表示
- タブレット: 適切な縦横比維持
- モバイル: タッチ操作最適化

### パフォーマンス考慮
- 動的import による遅延読み込み
- メモ化による不要な再描画防止
- 適切なクリーンアップ処理

## ファイル構成計画

```
frontend/app/
├── components/
│   └── MapLibre/
│       ├── MapComponent.tsx         # メインマップコンポーネント
│       ├── MapContainer.tsx         # マップコンテナー
│       └── index.ts                 # エクスポート
├── hooks/
│   ├── useMapLibre.ts              # MapLibre管理フック
│   └── index.ts                    # エクスポート
├── types/
│   ├── map.ts                      # マップ関連型定義
│   └── index.ts                    # エクスポート
├── route/
│   └── page.tsx                    # ルートページ
├── globals.css                     # グローバルスタイル
└── layout.tsx                      # ルートレイアウト
```

## 実装順序

### Phase 1: 基盤構築
1. package.json への依存関係追加
2. 基本的なMapComponentの作成
3. 型定義ファイルの作成

### Phase 2: コンポーネント実装
4. useMapLibreフックの実装
5. MapContainerコンポーネントの作成
6. スタイル設定の追加

### Phase 3: ページ統合
7. ルートページの作成
8. レスポンシブ対応
9. 動作確認とデバッグ

## 受け入れ基準

### 基本機能
- [ ] 地図が正常に表示される
- [ ] ズーム・パン操作が動作する
- [ ] レスポンシブデザインが適用されている
- [ ] TypeScriptエラーがない
- [ ] ビルドが正常に完了する

### パフォーマンス
- [ ] 地図の初期表示が3秒以内
- [ ] 操作時のラグがない
- [ ] メモリリークがない
- [ ] モバイルでも快適に動作

### コード品質
- [ ] TypeScript型安全性が保たれている
- [ ] コンポーネントが適切に分離されている
- [ ] 再利用可能な設計になっている
- [ ] Biome による静的解析をパス

## 技術的考慮事項

### MapLibre 初期化
- ブラウザー環境でのみ初期化
- useEffect での適切なタイミング管理
- クリーンアップ処理の実装

### Next.js App Router 対応
- 'use client' ディレクティブの適切な使用
- サーバーサイドレンダリング対応
- 動的import の活用

### 将来的な拡張性
- AWS Location Service との統合準備
- ルート描画機能の追加準備
- 事故マーカー表示機能の準備

## エラーハンドリング

### 想定されるエラー
- MapLibre 初期化失敗
- ネットワーク接続エラー
- ブラウザー互換性問題

### 対処法
- エラーバウンダリーの実装
- フォールバック UI の提供
- 適切なエラーメッセージ表示

## テスト計画

### 単体テスト
- コンポーネントの描画テスト
- フックの動作テスト
- 型定義の検証

### 結合テスト
- ページ全体の動作確認
- 異なるデバイスでの動作確認
- ブラウザー間の互換性確認

## デプロイメント準備

### ビルド確認
- TypeScript コンパイルエラーなし
- Biome 静的解析パス
- 本番ビルド成功

### 最適化
- バンドルサイズの確認
- 不要な依存関係の除去
- CSS最適化

---

## まとめ

この計画に従って、段階的にMapLibreマップコンポーネントを実装し、WorstRouteアプリの基盤となる地図機能を構築する。各フェーズごとに動作確認を行い、品質を確保しながら進める。

実装完了後は、AWS Location Service との統合やルート描画機能の追加など、より高度な機能への拡張が容易になる設計とする。